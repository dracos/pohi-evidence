EMV — Banking and Retail

NBX —- LINK Application Interface Specification (AIS)

FUJ00002044
FUJ00002044

ROLE Name AREA OF I SIGNATURE Date
RESPONSIBILITY

Authors Rex Dixon on behalf I Business

of Post Office Ltd Architecture

Product
Deployment
Technical
Architecture

DA Sign-off David Gray Design

(Peer Reviewer) Authority

Project lan Oakley Project

Manager Delivery

Fujitsu Gill Jackson

Services Sign-
off

Project:

NBX - LINK Application

Interface Specification (AIS) Doc Ref:

COMMERCIAL IN CONFIDENCE

FUJ00002044
FUJ00002044

EMV - Banking and Retail

NB/IFS/024

1 Document Control

1.1 Document Information

Horizon Release No:

T40

Document Title:

EMV Banking and Retail: NBX — LINK Application Interface Specification

Document Type:

Application Interface Specification

Abstract:

This document details the application interface between the Horizon

domain and LINK, including ICC and PIN Change

Document Status:

For review

Originator &
Department:

David Gray
Design Authority

Contributors:

Post Office
Distribution:

Design Authority - David Gray
POL Document Control — Post Office Programme Office

Supplier Distribution:

LINK — Geoff Barker
Fujitsu Services: Gill Jackson

Client Distribution:

N/A

Table 1: Document Information

1.2 Document History

Version I Date Reason for Issue Associated
WP /CT
0.1 19 Nov 2003 I First working draft. Based on document produced by IBM
entitled “Network Banking Engine: NBE —- LINK
Application Interface Specification (AlS)” version 3.0, and
including ICC support
0.2 3 Dec 2003 Updated to reflect version 4.0 of “Network Banking
Engine: NBE —- LINK Application Interface Specification
(AIS)”, also minor changes following discussions
0.3 12 Dec 2003 I Updated following joint review on 9/12/03
0.4 20 Jan 2004 ~—- Updated following review comments from POL
0.5 26 Jan 2004 ~—_ Updated following joint review on 22/01/04
1.0 9 Feb 2004 Updated following joint review on 5/02/04
14 7 Apr 2004 Updated following series of minor clarifications
1.2 13 May 2004 I Updated following series of minor clarifications
2.0 13 Aug 2004 Updated following joint review on 14/05/04 and
subsequent emails
Created on 19/03/2007 Version 4.0 Page 2 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
‘ NBX - LINK Application —_Project: EMV Banking and Retail
G&G Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
2.1 26 May 2005 Updated for CT 363 and for minor corrections discovered I CT 363 /
during testing prior to initial release at Horizon release I CP 3997
$75
2.2 3 Aug 2005 Updated as a result of comments received, and as a
result of re-accreditation testing
3.0 15 Aug 2005 _ Issued for Sign-off
3.4 3 Nov 2006 Changes to support PIN Change via LINK and to move to I CT 573/
LIS5 2007-1 CP 4295
3.2 20 Nov 2006 I Further minor changes. Version for formal review.
(Diagram in section 5.1 still needs updating for PIN
Change)
3.3 3 Jan 2007 Added Diagram in section 5.1 for PIN Change
4.0 149 Mar 2007 Issued for Sign-off
Table 2: Document History
1.3 Change Process
Any changes to this issued version of this document will be made, controlled and distributed by: -
IT_Controlled_Document_review@royalmail.com
1.4 Review Details
Review
Comments by :
Review Rex Dixon, Fujitsu Services
Comments to :
Mandatory Review Authority Name
Post Office Ltd David Gray
Fujitsu Services Ltd
Analysis & Solution Specification Gareth Jenkins
SI DU Design Authority Tom Northcott
SI DU Design Team Designer Rex Dixon
CS System Support Centre Manager I Mik Peach
SI Test Design Sheila Bamber
LINK Michael Abendstern
Optional Review / Issued for Information
Post Office Ltd Bob Booth, Seamus Scullion
Fujitsu Services Ltd
Release Manager James Stanton
DU Development Team Leader Peter Ambrose
Created on 19/03/2007 Version 4.0 Page 3 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

LINK

1.5 Changes in this Version

Version I Changes

4.0 Temporary section 0.8 (Issues) — Deleted.

3.3 Section 1.3 - Changed email address.

Section 5.1 — Added flow diagram for PIN Change
3.2 Changes to support PIN Change via LINK:

Section 3.1 - Clarified that the only PIN management function supported is PIN Change.
Added footnote that PIN management failure advice is sometimes referred to as PIN
management failure notification.

Section 4.2.1 — Application PAN Sequence Number (bitmap ref. 023): added
0624/0625/0634 into description.

Section 4.2.1 — Application Transaction Counter (bitmap ref. 137): added
0624/0625/0634 into description.

Section 4.2.1 — Original Data Elements (bitmap ref. 090): changed positions 1-4 from
0200 to 0100 for PIN Change reversals.

Section 4.2.2.2 — Authorisation Data (bitmap ref. 123): removed the erroneous
conditionality statement for a mandatory field; clarified presence of individual sub-fields.

Section 4.2.10.2 — Authorisation Data (bitmap ref. 123): clarified presence of individual
sub-fields.

Changes to PIN Change for LIS5 2007-1:
Section 1.7 - Changed to use 2007-1 version of PIN Management Service.

Section 4.2.1 - Application PAN Sequence Number (bitmap ref. 023): changed C to O
for 0624/0625 [correction in LISS 2007-1 PMS]

Section 4.2.6 — Authorisation Response Data (bitmap ref. 121): new field, ignored in this
implementation [addition in LISS 2007-1 PMS]

Section 4.2.10 - Application PAN Sequence Number (bitmap ref. 023): changed C to O
[correction in LISS 2007-1 PMS]

Other changes:
Front page — Replaced Beverley Dunn by lan Oakley.
Section 1.8 - Issues list updated.

Sections 4.2.3.2, 4.2.4.2, 4.2.9.2 — Authorisation Data (bitmap ref. 123): clarified
presence of individual sub-fields. [Documentary only]

3.41 Changes to support PIN Change via LINK:
Section 1.7 - Addition of LINK PIN Management Service.

Section 3.1 — Addition of PIN management messages (0100 & 0110) and PIN
management failure advice messages (0624/0625 & 0634).

Section 3.2 — Addition of 0624/0625 & 0634 messages.

Section 4.1.2 — Addition of four new columns for [R3] 0100 PIN, [A1] 0200 PIN, [E1]
0624/0625, and [E2] 0634. Statement added that the columns relating to PIN

Created on 19/03/2007 Version 4.0 Page 4 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

Management are specifically for PIN Change (PIN Unlock being excluded).

Section 4.1.2 — Advice/Reversal Reason Code (bitmap ref. 060): PIN Failure treated
same as Reversal

Section 4.1.2 — Authorisation Data (bitmap ref. 123): Sub-Field 13 contains the new PIN
for a PIN Change; Sub-Field 14 contains the Issuer Script Result in PIN Change Failure
Advice messages

Section 4.1.2 - Processing Code (bitmap ref. 003): new value for digits 1 and 2 for PIN
Change.

New sections 4.2.2, 4.2.6, 4.2.10 & 4.2.12 for the [R3], [A1], [E1] & [E2] for PIN Change,
with other sections renumbered accordingly.

Section 5.1 - Addition of 0624/0625 & 0634 messages.
Changes to move to LIS5 2007-1:
Section 1.7 — Updated to 2007-1.

Section 4.1.2 — Addition of Card Acceptor Identification Code (bitmap ref. 042) as
optional for Balance Enquiry (0100 & 0110).

Section 4.1.2 — Point of Service Data (bitmap ref. 061), new subfield 13 (Area of Social
Deprivation) set to 0, meaning Unknown.

Sections 4.2.1 & 4.2.5 (Balance Enquiry) — Addition of optional Card Acceptor
Identification Code (bitmap ref. 042). NBX will not generate this field.

Other corrections, purely documentary:

Section 3.4 —- Sentence on Point of Service Condition Code (bitmap ref. 025) removed in
line with change in 4.1.2 below.

Section 4.1.2 — Point of Service Condition Code (bitmap ref. 025): Description amended
to remove historic value 54 now that all NBX Counters have PIN Pads. Removed cross-
references to this description as they are now irrelevant.

Sections 4.1.2 & 4.2.9 —- Removed the following unsupported (greyed-out) fields as they
are not mentioned in any of the referenced LISS documents: Merchant Type (bitmap ref.
018); Acquiring Institution Country Code (bitmap ref. 019).

Sections 4.2.1 — Bit Map Secondary: added missing condition “Required for ICC.
transactions”.

Sections 4.2.1 & 4.2.5 (Balance Enquiry) - Removed erroneous inclusion of the following
unsupported (greyed-out) fields: Amount, Cardholder Billing (bitmap ref. 006);
Conversion Rate, Cardholder Billing (bitmap ref. 010); Currency Code, Cardholder Billing
(bitmap ref. 051). These should have been removed for LIS 2004-1 version 1.1.

Sections 4.2.1 & 4.2.5 (Balance Enquiry) —- Advice/Reversal Reason Code (bitmap ref.
060): added “and fallback” to align with Withdrawal/Deposit, as NBX behaviour is
identical in all cases. AIS was previously inconsistent.

Section 4.2.9 (Reversal Response) — Transmission Date and Time (bitmap ref. 007):
Removed erroneous comment “Echoed from the 042x message”.

Various sections — Card Acceptor Terminal Identification (bitmap ref. 041): corrected
field name from ‘Identifier’. AIS was previously inconsistent.

Miscellaneous:
Changed Horizon Release to T40.
Added new, temporary section on Issues.

3.0 Gill Jackson added as signatory for Fujitsu Services
2.2 Section 4.1.2 - Amount, Transaction (bitmap ref. 004): removed reference to EUR cents.
Created on 19/03/2007 Version 4.0 Page 5 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

Section 4.1.2 — Authorisation Data (bitmap ref. 123): Sub-Field 14 removed as it only
applies to PIN changes, which are not supported.

Section 4.1.2 — Data, Expiration (bitmap ref.014): added clarification “This will only be
for deposits”.

Section 4.1.2 - Message Security Code (bitmap ref. 096): format corrected from “an” to
“ans”.

Section 4.1.2 — Point of Service Data (bitmap ref. 061), subfield 9 (Cardholder
authentication entity): added value 0 (Not authenticated) if not PIN (i.e. for a deposit).

Section 4.1.2 — Point of Service Data (bitmap ref. 061), subfield 12 (PIN capture
capability): added value 0 if no PIN entry capability (i.e. for a deposit).

Section 4.1.2 - Track 2 Data (bitmap ref. 035): added condition that it will not be present
where card details have been manually entered.

2.1 Section 1.1 —- Horizon Release updated to S80R.
Section 1.7 — Updated to LISS 2005-1.

Sections 4.1.2, 4.2.1.2, 4.2.2.2, 4.2.3.2, 4.2.4.2, 4.2.5.2 and 4.2.6.2 — Application PAN
Sequence Number (bitmap ref. 023): clarified that it is required for manually entered
transactions only when the card's issue number has been captured. [FS Peak 110188,
110679]

Sections 4.1.2 and 4.2.1.2 — Authorisation Data (bitmap ref 123): removed from 0100
message. [POL Incident 1153; FS Peak 108959]

Section 4.1.2 — Point of Service Data (bitmap ref. 061), subfield 2 (Cardholder
authentication capability): added value 0 (No electronic authentication) for deposits.
[LINK MTPR 0292, 0295; POL Incident 1212; FS Peak 110150]

Section 4.1.2 — Point of Service Data (bitmap ref. 061), subfield 3 (Card capture
capability): changed to 0 (no capture) from 1 (capture). [LINK MTPR 0275; POL Incident
1159; FS Peak 108967]

Section 4.2 — Corrected description of which bitmaps appear in the definitions.

Section 4.2.4.2 (Balance Enquiry Response) — Clarified that, for a decline, the length of
this field must be set to ‘000’. [POL Incident 1196]

Section 4.2.7.2 (Reversal Request) — Added a note that NBX does not include any of the
Optional fields.

Table 3: Changes in this Version

1.6 Key Contacts

Name I Position I Phone Number
Bob Booth Solutions Architect
Michael Abendstern Technical Specialist

Table 4: Key Contacts

1.7 Associated Documents

Created on 19/03/2007 Version 4.0 Page 6 of 55
© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
I Reference Version I Date Title Source
LISS 2007-1 LINK Switch Service Interchange LINK
Vsn 1.0 Standard — LINK ATM Scheme Service
2004-1 LINK Reconciliation File Specification LINK
Vsn 1.0 (LREC) Standard Formats
SU/PLA/O16 I 0.3 NB Volume Model Comparisons Post Office
NB/IFS/028 NBX — LINK Technical Interface Post Office
Specification
NB/IFS/033 Horizon — LINK Mapping Post Office
2007-1 LINK Switch Service Interchange LINK
Vsn 1.0 Standard — LINK Deposits Service
Vsn 5.6 I Jan LINK Switch Service Interchange LINK
2002 Standard (LISS Security Standard)
2007-1 LINK Switch Service Interchange LINK
Vsn 1.0 Standard — LINK PIN Management
Service

Table 5: Associated Documents

Unless a specific version is referred to above, reference should be made to the current approved versions

of the documents.

Created on 19/03/2007
© Post Office™ 2004-2007

Version 4.0

Page 7 of 55
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Table of Contents
1 DOCUMENT CONTROL 2
1.1. Document Information 2
1.2. Document History 2
1.3. Change Process 3
1.4 Review Details 3
1.5. Changes in this Version 4
1.6 Key Contacts 7
1.7 Associated Documents 7
2 INTRODUCTION 10
2.1 Scope 10
2.2 Structure 10
2.3 Terms and Abbreviations 10
3 OVERVIEW OF THE INTERFACE 11
3.1. Data Description 1
3.2 Derivation and Use of Data 13
3.3. Non Computer Data 15
3.4 — Clarifications to LINK Standard 15
4 DATAITEMS 16
4.1 Data Item List 16
4.14.1 General Message Element Definitions and Abbreviations 16
4. Messages Data Elements 17
4.2 Data Interpretations 28
4.2.1 [R3] - Balance Enquiry 29
4.2.2 [R3] - PIN Change Request 30
4.2.3 [R3] - Financial Transaction Request - Withdrawal 31
4.2.4 [R3] - Financial Transaction Request - Deposit 33
4.2.5  [A1] - Balance Enquiry Response 35,
4.2.6 [A1] - PIN Change Response 36
4.2.7 [A1] - Financial Transaction Request Response - Withdrawal 37
4.2.8 [A1] - Financial Transaction Request Response - Deposit 38
4.2.9  [E1] - Reversal Request - Financial Transaction 39
4.2.10 [E1]- Reversal Request - PIN Change 41
4.2.11  [E2] - Reversal Request Response — Financial Transaction 43
Created on 19/03/2007 Version 4.0 Page 8 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV — Banking and Retail
& Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE

4.2.12 [E2] - Reversal Request Response — PIN Change 44

4.2.13 Administration Advice (0620) 45

4.2.14 Network Management Messages (0800 / 0810) 46

4.2.15 LREC — Reconciliation File 47
5 TRANSFER STRUCTURE 48
5.1. Transfer Grouping 48
5.2 Transfer Structure 49
5.3. Record Structure 49
5.4 Sequences 49
5.5 Data Volumes 49
5.6 Data Authentication 50
5.7 Data Dictionary 50
6 SECURITY OF TRANSMITTED DATA 51
6.1 Protected Data 51
6.2 Encryption and Decryption Methods 51
6.3 Session Establishment 51
6.4 Key Management 51
7 OPERATIONAL PROCEDURES 53
7.1. Processing Cycles 53
7.2 Transfer Initiation 53,
7.3. Security Procedures 53
7.4 Fallback Procedures 53
7.5 Downgrade Transactions 53
7.6 Control 54
8 APPENDIXA 55
8.1 Response Codes and Reversal Codes 55

Created on 19/03/2007 Version 4.0 Page 9 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

2 Introduction
The purpose of this document is:
* To specify the interface between the NBX and LINK systems using LIS5.
e To provide the development teams with sufficient detail to develop the NBX - LINK interface.

« To provide a consistent communications vehicle amongst the development teams that have
responsibility for developing the various components comprising the application.

2.1 Scope
This document applies to the interface between the NBX and LINK only. It includes only those financial

transaction messages, network messages, reconciliation and settlement messages sufficient to support the
financial services being delivered by Post Office Limited via the LINK systems.

2.2 Structure

This AlS document follows Post Office Limited’s AIS standard.
Section 3 contains a high level overview of the NBX — LINK interface and its context.

Section 4 contains a detailed description of the messages to be exchanged, and the derivation and use of the
exchanged data items. All data items exchanged are specified in LISS.

Section 5 contains details of the data transfer.

Section 6 contains details of security of the exchanged data items. This section identifies the security needed
for each data item (e.g. encryption) and details of the method to be used.

Section 7 contains any relevant details of operational procedures relating to the interface.

2.3 Terms and Abbreviations

Not used

Created on 19/03/2007 Version 4.0 Page 10 of 55
© Post Office™ 2004-2007
NBX - LINK Application Project:
Interface Specification (AIS)

EMV - Banking and Retail

FUJ00002044
FUJ00002044

Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
3 Overview of the Interface
3.1 Data Description
The following messages are exchanged over the NBX - LINK interface:
NBX Description Direction
Message Id
[R3] Authorisation / Financial Transaction Request: NBX > LINK
* balance enquiry (0100)
e PIN change (0100)
« withdrawal (0200)
« deposit (0200)
The only PIN management function supported
by NBX is PIN Change (there is no support for
PIN Unlock).
Note: there is no separate message to LINK for
withdrawal with balance. LINK will always return
the balance to NBX if sent by the issuer.
[A1] Authorisation/Financial Transaction Request LINK > NBX
Response:
e balance enquiry response (0110)
e PIN change response (0110)
« withdrawal response (0210)
e deposit response (0210)
Each of the above will have a response code
that indicates approve or decline with reason
and any required action (e.g. card retention).
{E1] Reversal Request: NBX > LINK
* reversal (0420)
« reversal repeat (0421)
* PIN management failure advice’ (0624)
e PIN management failure advice repeat
(0625)
Please note that the number of times the 0421
and 0625 message is sent is configurable within
the NBX, up to a maximum of 9,999 times.
{E2] Reversal Request Response: LINK > NBX
* reversal response (0430)
e PIN management failure advice response
(0634)

‘ Also referred to as ‘PIN management failure notification’ in LINK PIN Management Service (Ref [8]).

Created on 19/03/2007 Version 4.0

© Post Office™ 2004-2007

Page 11 of 55
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV ~ Banking and Retail
Interfé SI ificatic (AIS)
Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
0620 Administration Advice (0620) NBX > LINK
Administration advice messages (0620) are sent I LINK > NBX
to/from LINK in order to initiate investigation of
a problem by either LINK or the NBX
0800 Network Management Request (0800): LINK > NBX
e Echo test (handshake) -
e Logon / Logoff NBX > LINK
e End of Day (cutover)
e Security Key Change
e« Key Change Request
¢ Online Key Verification
0810 Network Management Request Response NBX > LINK
(0810)
LINK ->  NBX
LREC Reconciliation File LINK > NBX
(The Report/Standard file format will be used for
the LREC file (Ref. [2]. The file transfer
mechanism and conditions of transfer are
described in the NBX — LINK Technical Interface
Specification (Ref. [4]).
Created on 19/03/2007 Version 4.0 Page 12 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

3.2 Derivation and Use of Data

The messages listed above are generally exchanged as a result of a transaction initiated either by a clerk at a
Post Office outlet or by LINK. The NBX acts as a message router, filtering messages based on business rules
and transforming received messages into the appropriate format for forwarding to the next system in the
message sequence.

The following table shows the derivation and use of each message exchanged between the NBX and LINK in
terms of the received message that causes each NBX - LINK message to be exchanged, and the transmitted
message resulting from the NBX - LINK message exchange:

Message Sequence
Horizon Horizon NBX LINK
Outlet Campus
[R1]> [R2] > 0100/0200
[R3] >

< [A3] < [A2] <
0110/0210
{A1]

[Co] > [C2] > 0420/0421/
0624/0625
[E>

e
0430/0634
{E2]

The messages exchanged over this interface relating to end of day, reconciliation and settlement are initiated
by LINK, and are neither derived from received messages nor used to generate onward messages.

Security key exchange messages are initiated by LINK or NBX and acknowledged by the other party. Either
LINK may send a new AWK or NBX may request that LINK sends a new AWK. After a Logon initiated by
either party LINK will send a new AWK. The connection type is Acquirer only. The following table shows the
derivation and use of each security message exchanged between LINK and the NBX. See Ref. [7].

Created on 19/03/2007 Version 4.0 Page 13 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV - Banking and Retail
& Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Message Sequence
Horizon Horizon NBX LINK
Outlet Campus
< 0800 (Logon
061)
0810 =
< 0800 (Key
Change -
Acquirer zone
code 161)
0810 >
0800 (Logon >
071)
€ 0810
& 0800 (Key
Change -
Acquirer zone
code 161)
0810 >
< 0800 (Key
Change -
Acquirer zone
code 161)
0810 Ed
0800 (Key Ss
Change
Request -
Acquirer
zone 181)
<= 0810
< 0800 (Key
Change -
Acquirer zone
code 161)
0810 >
< 0800 (Online
Key
Verification
Acquirer ZMK
code 199)
0810 =>

Other 0800 messages may be initiated by either LINK or NBX (with the exception of the End of Day message,
which is LINK initiated), and are acknowledged by a 0810 response from the other side.

The use of Handshakes is described in the NBX — LINK Technical Interface Specification (Ref. [4]).

All 0100 and 0200 messages sent out by NBX prior to sending the 0810 approved key change will have used
the current AWK to encrypt the PIN Block. As soon as the 0810 approved response is transmitted, the new
AWK becomes active so that all messages generated after its receipt use the new AWK to encrypt the PIN
Block.

In the event that the Key Check Value received by NBX (with the AWK in the 0800 Key Change message)
does not match the one created when testing the new AWK, NBX will return a 0810 denied response. Under
these circumstances the new AWK will NOT be implemented and any subsequent transactions will continue to
have the PIN Block encrypted using the current AWK.

Created on 19/03/2007 Version 4.0 Page 14 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

When a new AWK is sent, LINK sets a timer flag which inhibits further key exchanges. This flag is unset
enabling further key exchanges, after a configurable period (currently 2 minutes), if a key exchange is not
received.

3.3 Non Computer Data

All data being transported across this interface is originated/received from a connected computer system or
from reference data (supplied by the Post Office Limited RDS or held internally within the NBX).

3.4 Clarifications to LINK Standard

Transaction Amounts are likely to contain pence - they will not be rounded to whole pounds or ten’s of
pounds.

Created on 19/03/2007 Version 4.0 Page 15 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

4 Data Items

4.1 Data Item List

4.1.1. General Message Element Definitions and Abbreviations

The following section summarises the list of LINK Message Elements for each group of transactions, together
with which message(s) they are present in. Each message is classified and identified using the RAC (Request
/ Authorise / Confirm) model. Each message element references the corresponding ISO 8583 bitmap position.

The ISO 8583 bit map reference has been included for ease of reference.

The abbreviations used to describe the format of each data element (DE) and Data Sub-elements are shown
in the following table (taken from the LINK Switch Service Interchange Standard (LISS), (Ref. [1]):

Notation IExplanation
a Alphabetic characters only (upper case)
in Numeric Digits only
s Special characters
fan (Alphabetic (upper case) or Numeric characters
as Alphabetic (upper case) or Special characters
ins. Numeric or Special characters
ans Alphabetic (upper case), Numeric or Special characters only
DD Day
MM Month
YY Year
hh Hour
mm Minutes
ss Seconds
LL Length of variable field that follows represented using two characters
LLL Length of variable field that follows represented using three characters
VAR, Variable length field
3 Fixed length field (e.g. 3 characters in this example)
70 Variable length field (e.g. up to a maximum of 10 characters in this example). LL or
LLL to indicate the actual length of the field will prefix all variable length fields.
h hexadecimal representation of the data
iz tracks 2 and 3 data as defined by ISO 7811 and ISO 7813
The Field Size column gives the number of characters (octets) required for the data item, as shown in the
table below.
Abbreviation I Description
3 Fixed Length field. Numeric fixed length fields are right justified and zero
padded. Fixed length string fields are left justified and space padded.
10 Variable length field (up to a maximum of 10 characters in this example).

Notes:
e Fixed length numeric fields are unpacked, right justified and zero filled.
e Fixed length alphanumeric fields are left justified and space filled.

The “Required” column indicates whether the field is Mandatory or Conditional for the messages defined in this
AIS. For conditional fields, the field description should indicate under what circumstances the data for the field
should be populated or omitted from the message.

The “Description” column contains a brief description of the field, as used in the messages defined in this AIS
together with any additional comments.

The LINK and NBX Servers both use the ASCII English character set (CCSID = 437).
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

4.1.2. Messages Data Elements

The LISS Data Elements exchanged within messages over this interface are listed below. A fuller description is given in the LINK Switch Service
Interchange Standard (LIS5), (Ref. [1]). The ICC data elements are represented from the 3° bitmap on this interface.

A greyed out row in the following tables means that the field is not required and may not be populated in messages from NBX to LINK. The NBX will log
any such fields received from LINK but will not process them further.

The values for ‘Required’ in the columns relating to PIN Management messages specifically reflect the values for PIN Change transactions.

LISS Data Element I BitmapI Format IField SizeI Source IDescription Required
ibe 1R3} I (3) I (R3} I (At) I ft} I 1} I 11] I 11] I 1€2) I t€2) I 0620 I 0800 I 0810
0100 } 0100 I 0200 } 0110 I 0110 I 0210 I 0420 I 0624 I 0430 I 0634
BEnqI PIN BEnqI PIN 10421 I (0625,
Account Identification 1 102 I ans ..28 I Issuer INBX does not pass Account Identification 1 field to the counter M mi
LLVAR systems
Acquiring Institution 032 n ..11 I NBX from ICode identifying the Acquirer (Post Office Limited). Set to mImMImMImMImM{ImM]mM]mM][ mM]
Identification Code LLVAR Ref Data 2200040000 preceded by a length indicator of 10.
Additional Amounts os4 I an I..120 Bank identifies account balance value (included by LINK if provided M c
LLLVAR Py bank)
IAdditional Response Data I 044 I ans 225 Bank _INot appropriate to messages passed on this interface.
LLVAR
Created on 19/03/2007 Version 4.0 Page 17 of 55

© Post Office™ 2004-2007
NBX - LINK Application Project: EMV - Banking and Retail

Interface Specification (AIS)

Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

FUJ00002044
FUJ00002044

Advice / Reversal Reason I 060
Code

an
LLLVAR

NBX

Required for Advice, Reversal/PIN Failure and ICC
transactions.

Used in request messages from ICC capable terminals to
indicate Status of Last Chip Read attempted and to provide
ICryptogram Information Data
Magnetic stripe cards
Reversal & PIN Failure Requests (0420/0421 & 0624/0625
messages):

Bytes 1-2 are set to 80

Bytes 3-4 give a reason for the reversal

Remaining bytes are not transmitted
ICC cards
[3] Requests (0100/0200 messages):

Bytes1-2 are set to 30

Byte 3 is Status of Last Chip Attempt

Bytes 4-5 is Cryptogram Information Data
Fallback [R3] Requests (0100/0200 messages):

Bytes1-2 are set to 30

Byte 3 is Status of Last Chip Attempt (value 2)

Bytes 4-5 is Cryptogram Information Data (value CO)
Reversal & PIN Failure Requests (0420/0421 & 0624/0625
messages):

Bytes 1-2 are set to BO

Bytes 3-4 give a reason for the reversal

Byte 5 is Status of Last Chip Attempt

Bytes 6-7 is Cryptogram Information Data

See Appendix A for Reversal/PIN Failure Reasons

IAmount, Cardholder Billing} 006

INot appropriate to messages passed on this interface — foreign
currency transactions are not supported by NBX.

Amount, Transaction 004

Clerk at
Outlet

Decimal amount in smallest unit of the specified currency (e.g
IGBP pence)

Not required for balance enquiry

IAmount, Transaction Fee I 028

an

Post Office Limited will not apply Acquirer charges (format
lannnnnnnn)

Amount, Transaction 030
Processing Fee

an

Bank

Issuer charge. This field will not be returned by LINK in a LINK
denied transaction (format annnnnnnn).

Application interchange I 138
Profile (AIP)

Icc

From ICC, indicating capability to support specific functions in

application

Created on 19/03/2007
© Post Office™ 2004-2007

Version 4.0

Page 18 of 55
NBX - LINK Application Project: EMV ~ Banking and Retail

Interface Specification (AIS)

Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

FUJ00002044
FUJ00002044

Application PAN
ISequence Number

023

Clerk at
Outlet

Identifies and differentiates cards with the same PAN

Required for ICC transactions, or if the card's issue number
has been manually entered

IAcquirer decision as to whether sent in the reversal message
(0420/0421 & 0624/0625) — copied from original transaction.
Required in 0430 if present in 0420/0421 & 0624/0625.

Application Transaction
Counter (ATC)

137

Iec

IA sequence number (counter) calculated by the ICC and
passed to the terminal application.

lAcquirer decision as to whether sent in the reversal message
(0420/0421 & 0624/0625) — copied from original transaction
Required in 0430 & 0634 if present in 0420/0421 & 0624/0625.

Authorisation Data

123

ans
LLLVAR

255

Clerk at
Outlet

ISub-Fields 1-12, 15, 16 do not apply.

ISub-Field 13 contains the new PIN for a PIN Change, omitted
otherwise.

Format of Sub-Field 13 is: h 16

ISub-Field 14 contains the Issuer Script Result for a PIN
IChange Reversal, or 0000 if timed out waiting for the PIN
Change Response. Otherwise omitted

Format of Sub-Field 14 is: h.. 12

ISub-Field 17 contains number and value of cheque deposit if
applicable. Number of cheques will be set by NBX to 001

Format of sub field 17 is:n 15
Position 1-3 Number of cheques (001 for NBX)

Position 4-15 Value of cheques (in the smallest unit of
transaction currency)

ISub-Field 18 Bilateral Discretionary Data must contain Start
Date of card where one exists and the card details have been
manually entered

Format of Sub-Field 18 is: ans .. 99

(Authorisation Identification
Response

038

an

Not required for NBX transactions - POS Transactions Only

[Authorisation Response
Data

121

ans
LLLVAR

eeo8)

Not required for NBX transactions - used for Cheque
Clearance Date.

This could be returned by an issuer to state when cheque fundsI

Iwill clear. NBX must be able to accept this, but will log only.

Created on 19/03/2007

© Post Office™ 2004-2007

Version 4.0

Page 19 of 55
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS,
Pp (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
lAuthorising Agent 113 n aM Bank institution approving or declining the transaction M
Institution Id Code
LLLVAR
Bit Map Secondary 001 h 16 I NBX from Iindicates presence of data elements in a message in range 065 miuIuM/uI[ uM] uM} uM]
system  Ito 128. This data element may be omitted if no elements in
range 065 to 128 are contained in message
Bit Map Tertiary 065 h 16 I NBX from IRequired for ICC based transactions (i.e. data elements in clc}]c]cl}e
system range 129 to 192)
ICard Acceptor 042 I ans 15 I NBX from IWhere required, NBX will populate with the Post Office Short mi
Identification Code system _IName (see Ref. [5] from Reference Data, left justified and
[space filled. NBX will omit it for Balance Enquiries,
First 40 characters of outlet address in format:
ICard Acceptor Name / 043 I ans 40 I NBX from Mi
Tocation Ref Data _I01-23 first 23 characters of ADDRESS 1
[24-38 first 15 characters of City
(= first 15 characters of ADDRESS 4)
139-40 GB
Note: this field can be sent to LINK in mixed case (except GB
which must be in upper case)
ICard Acceptor Terminal I 041 I ans 8 I Outlet from IComprises 6 digit outlet id (group_id) + 2 digit terminal id mMimM]o
Identification system I(node_id)
Conversion Rate, 010 n 8 Not required - foreign currency transactions are not supported
Cardholder Billing by NBX.
ICryptogram (ARQC) 136 h 16 ICC IComputed by ICC for on-line application o}o
ICryptogram Amount 147 n 12 ICC Transaction amount used by ICC in generating cryptogram o}o
ICryptogram Currency 148 n 3 ICC IContains transaction currency code used by ICC in generating o}o
Code lcryptogram for an ICC transaction
ICryptogram Transaction I 144 n 2 ICC IContains transaction type used by ICC in generating the o}o]olfo
Type lcryptogram for an ICC transaction
Currency Code, 051 an 3 Not required - foreign currency transactions are not supported
Cardholder Billing by NBX
[Currency Code, 049 I an 3 Clerk at IOnly 826 (GBP) will be accepted by LINK initially. NBX will mi M
Transaction outlet Itranslate GBP code received from Counters to 826 (using ISO
14217 standard) for LINK. Other values may be added to
Currency Code CPF Table if required at a later date, and will be
translated in the same way.
Date, Expiration o14 I Yum 4 Clerk at IMay be required where the card data is manually entered, c
Outlet _ [determined by the reference data at the counter. This will only
be for deposits
Created on 19/03/2007 Version 4.0 Page 20 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS,
Pp (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Date, Local Transaction I 013 I MMDD I 4 _ I Outlet from IAs printed on receipt, transaction request date in Local Time M
System
Date, Settlement 015 I MMDD I 4 I NBX, then INBX sets in request to Acquirer's settlement date, LINK sets in M
LINK response to Switch settlement date
The reversal message will contain the original, NBX set
[Settlement Date.
File Name 101 I ans 17 Not appropriate to messages passed on this interface.
File Update Code 091 an 1 INot appropriate to messages passed on this interface.
Forwarding institution 033 n 1 Not required, since NBX is an Acquirer only
ti
Identification Code ne
Info Text 124 I ans 255 I Sender IContains up to first 255 bytes of the message rejected by the M
LULVAR Isender (either NBX or LINK
Issuer Application Data 134 h 64 ICC IUnique ICC related card data for card scheme (LINK)
LLVAR
icati 139 ph 32 I Issuer _IA value computed by the Issuer to allow the ICC to authenticate
[ssuer Authentication Data LLVAR the issuer returning the response. Comprises two sub-fields:
JM Sub-field 1 - ARPC (format h16) - must be included in a
response to a message where the ARQC has been
verified successfully by the Issuer
lm Sub-field 2 - Optional Data (format ..h16)
Issuer Script 142 h 255 I Issuer IContains commands for transmission to ICC from Issuer
LLLVAR
Issuer Trace Id 126 I ans 6 Issuer Issuer specified transaction identifier. Note: The field is FIXED M
LULvAR length 6 but with the var field header ie LLLnnnnnn
Message Authentication I 064 h 16 Not currently supported by LINK
Code
Message Authentication I 128 h 16 Not appropriate to messages passed on this interface.
Code
Message SecurityCode I 096 I ans 8 Sender IPassword to network management requests. Value set = c
I435TT (both directions)
Created on 19/03/2007 Version 4.0 Page 21 of 55

© Post Office™ 2004-2007
NBX - LINK Application Project: EMV - Banking and Retail

Interface Specification (AIS)

Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

FUJ00002044
FUJ00002044

Network Management
Information

125

ans
LLLVAR

60

Sender

/Additional information required for key change and key
verification:

= Positions 01-32 - 32 byte working key

= Positions 33-38 - check value

Im Positions 39-60 - Spaces (optional)

Network Management
Information Code

070

ICodes to be used for 0800/0810 messages are defined in
section 4.2.14.

[Original Data Elements

090

42

NBX

Positions 1-4 will be set to the message type identifier of the
original transaction

le 0200 for 0420/0421/0430
le 0100 for 0624/0625/0634

Remaining positions are zero filled

PIN Data

052

Outlet from
customer

Customer PIN Entered by customer & encrypted using ISO
19564-1 Format 0 as defined in ANSI X9.8. Not supplied for
verification by signature or deposit transactions (as no PIN

authentication of the customer is undertaken).

Point of Service Condition
Code

025

Outlet

Will be set to 55 to indicate ICC Capable Branch ATM.

Created on 19/03/2007

© Post Office™ 2004-2007

Version 4.0

Page 22 of 55
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS,
Pp (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Point of Service Data 061 I ans 20 NBX — ISubfield 1 will be set to:
8 — Mag. stripe & key entry (counter not ICC enabled)
9—Mag. stripe, ICC & key entry (counter ICC enabled)
ISubfield 2 will be set to:
1-PIN,
0 - No electronic authentication (assumed for deposit)
ISubfield 3 will be set to 0 - No capture
[Subfield 4 will be set to 1 - On premises of card acceptor,
attended,
ISubfields 5 and 6 will be set to 01 — Cardholder present, card
present,
[Subfield 7 will be set to: 2 Magnetic stripe, 5 - ICC, 6 -
Manual Entry
ISubfield 8 will be set to 1 — PIN, 0 — No PIN (if deposit
transaction)
[Subfield 9 will be set to 3 (Authorising agent = issuer) for PIN, 0}
(No authentication) if not PIN (i.e. for a deposit)
ISubfield 10 = 1 (none) or 3 (ICC)
[Subfield 11 = 0 (unknown — mixed print & display capability,
lover time)
ISubfield 12 = C (pin capture length is up to 12 — h/w capability,
lusage is likely to be 4 digits only) if PIN entry capability, 0 ifno
PIN entry capability (i.e. for a deposit).
ISubfield 13 = 0 (unknown / not located in an area of social
deprivation)
Point of Service Entry 022 n 3 I Outlet from IDigits 1-2 will be:
Mode system
ys lo1 (Manual entry)
os (icc)
190 (Mag Stripe, Track 2 read and fully transmitted, includes.
downgraded ICC cards)
Digit 3 will be:
1 (PIN entry capability)
2 (No PIN entry capability) - assumed for deposit
Point of Service PIN 026 n 2 INot appropriate to messages passed on this interface - POS
Capture Code Transactions Only
Created on 19/03/2007 Version 4.0 Page 23 of 55

© Post Office™ 2004-2007
FUJ00002044

generating the cryptogram for ICC transaction

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS,
Pp (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Primary Account Number I 002 ] n 19. [Outlet from IRead from ICC for an ICC transaction, read from Track 2 data
card/Clerk Iif card swiped, entered by the clerk when card details manually
LLVAR at Outlet entered
[identifies particular card, customer account or relationship]
Processing Code 003 I on 6 NBX — INBX will set digits 1 and 2 to M
01 for Withdrawal
31 for Balance Enquiry
21 for cash deposit
124 for cheque deposit
120 for PIN Change.
Digits 3 to 6 will be set to zero (default). All 6 digits passed by
NBX and LINK.
Replacement Amounts I 095 I an 42 Not required - partial reversals not supported by NBX
Response Code 039 I an 2 ICode indicating transaction step outcome. Source dependent M M
lon transaction type
Retrieval Reference 037 I an 12 NBX — IAdditional transaction identifier, assigned by NBX. It will be M
Number? lunique for a terminal ID, at least within 10 years.
Digits 01-04 set to date (YDDD)
Digits 05-06 set to 00
Digits 07-12 set to a 6 digit cycling number generated at each
counter
[systems Trace Audit on n 6 NBX — {Transaction identifier, assigned by NBX within the request, and mi mMI[u[o
Number included in all subsequent messages relating to that transaction
((A1] response and [E 1] / [E2] reversal messages)
Terminal Capability Profile I 130 I —h 6 Outlet [Required for ICC transactions - indicates card data input, CVM
land security capabilities of terminal
HTetminal Country Code I 145 I 3 Outlet Country Code (ISO value) of terminal carrying out ICC
transaction — value = 826
Terminal Serial Number I 133 I an 8 Outlet [Unique and permanent identification number of chip terminal
Terminal Transaction Date] 146 I n 6 Outlet [Contains transaction date in format YYMMDD used by ICC in

? Fields Systems Trace Audit Number (011), Time Local Transaction (012), Retrieval Reference Number (037) and Card Acceptor Terminal Identification (041) are used to uniquely identify transactions

Created on 19/03/2007

© Post Office™ 2004-2007

Version 4.0

Page 24 of 55
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS,
Pp (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Terminal Verification 131 h 10 Outlet [Status of different ICC functions as seen from terminal c
Results (TVR)
Time, Local Transaction I 012 n 6 I Outlet from IAs printed on receipt, transaction request time in Local Time in I M M
System [format hhmmss
Track 2 Data 035 z 37 I Outlet from ITrack 2 image. Will not be present where card details have c
HI
LLVAR card — [been manually entered.
Transmission Date and I 007 n 10 Sender Date and time of transmission of the message (not carried M miu] M]™
Time orward from previous messages), expressed in GMT or BST
las appropriate, Format MMDDhhmmss
[Unpredictable Number 132 h 8 I Generated IValue providing variability and uniqueness to generation of the I C
by terminal [application cryptogram for an ICC transaction
Created on 19/03/2007 Version 4.0 Page 25 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

4.2 Data Interpretations

This section contains the definition of each message type to be sent over this interface. The Message
Element column lists those elements required for the message by Horizon name, and relates to list in Section
4.1.

The Required column in the message definition tables within this section contain the following codes:

Code Meaning

M The element is mandatory and must be present in this message

c The element is conditional for this message, and the condition to be applied is
stated in the Conditions column. If the condition is true, the element must be
present in the message, otherwise the element must not be present in the
message. It should be noted that the receiving system may not be able to
assess whether the condition has been met, in which case it must be able to
interpret the presence or non-presence of the element according to appropriate
business rules.

fe} Optional (see Message Definitions below for specific rules)

The Conditions column lists the conditions for inclusion of a conditional message element; inclusion of the
element may depend on details of the transaction type, or simply whether the data is available to the sending
system.

The message definitions given in the sections below do not include primary bitmaps. Primary, secondary and
tertiary bitmaps will be used as required by the LINK Switch Service Interchange Standard (LISS5), (Ref. [1]).

It is essential that developers of this interface also refer to the LINK Switch Service Interchange Standard
(LISS), (Ref. [1]) and the Horizon - LINK Mapping document, (Ref. [5]) for further details of data derivation
and use.

A greyed out row in the following tables means that the field is not required and may not be populated in
messages from NBX to LINK. The NBX will log any such fields received from LINK but will not process them
further.
NBX - LINK Application

Interface Specification (AIS)
COMMERCIAL IN CONFIDENCE

FUJ00002044

FUJ00002044

Project: EMV - Banking and Retail

Doc Ref: NB/IFS/024

4.2.1
4.2.1.1

4.2.1.2

Overview

[R3] - Balance Enquiry

This message is sent by the NBX to LINK. The message requests a balance enquiry transaction.

The [R3] Balance Enquiry message maps to the following LINK message:

e 0100 - Balance Enquiry

© Post Office™ 2004-2007

Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference

Bit Map Secondary 001 Cc Required for ICC transactions

Primary Account Number 002 M

Processing Code 003 M 310000 for Balance Enquiry

Transmission Date and Time (007 M

‘Systems Trace Audit Number O17 M

Time, Local Transaction 012 M

Date, Local Transaction 013 M

Date, Expiration 014 Cc Required for manually key entered balance enquiry
transaction

Date, Settlement 015 M ‘Acquirer's settlement date

Point of Service Entry Mode 022 M Please refer to 4.1.2 for values

‘Application PAN Sequence Number 023 Cc Required for ICC transactions, or if the card's issue
number has been manually entered

Point of Service Condition Code 025 M

Acquiring Institution Identification 032 M

Code

Forwarding Institution Identification 033 Not required

Code

Track 2 Data 035 Cc Will not be present where card details manually
entered.

Retrieval Reference Number 037 M Please refer to 4.1.2 for contents of the field

‘Card Acceptor Terminal Identification 047 M

Card Acceptor Identification Code 042 Not Sent to LINK by NBX

Card Acceptor Name / Location 043 M

‘Currency Code, Transaction 049 M

PIN Data 052 Cc Required if PIN used

Advice / Reversal Reason Code 060 Cc Required for ICC and fallback transactions

Point of Service Data 061 M Please refer to 4.1.2 for values

Message Authentication Code 064 Not to be sent fo LINK for this implementation,

Bit Map Tertiary 065 Cc Required for ICC transactions

Terminal Capability Profile 130 Cc Required for ICC transactions

Terminal Verification Results 131 Cc Required for ICC transactions

Unpredictable Number 132 Cc Required for ICC transactions

Terminal Serial Number 133 oO) Optional for ICC transaction - to be inserted if available

Issuer Application Data 134 Cc Required for ICC transactions

‘Cryptogram (ARQC) 136 Cc Required for ICC transactions

Application Transaction Counter 137 Cc Required for ICC transactions

Application Interchange Profile 138 Cc Required for ICC transactions

Cryptogram Transaction Type 144 Cc Required for ICC transactions

Terminal Country Code 145 Cc Req'd for ICC transactions — see 4.1.2 for value

Terminal Transaction Date 146 Cc Required for ICC transactions

Cryptogram Amount 147 Cc Required for ICC transactions

Cryptogram Currency Code 148 Cc Required for ICC transactions

Message Authentication Code 792 Not requirediin this implementation

Created on 19/03/2007 Version 4.0 Page 27 of 55
NBX - LINK Application

Interface Specification (AIS)
COMMERCIAL IN CONFIDENCE

FUJ00002044

FUJ00002044

Project: EMV - Banking and Retail

Doc Ref: NB/IFS/024

4.2.2
4.2.2.1

4.2.2.2

Overview

[R3] - PIN Change Request

This message is sent by the NBX to LINK. The message requests a PIN Change transaction.

The [R3] PIN Change message maps to the following LINK message:

« 0100 - PIN Management Authorisation Request

© Post Office™ 2004-2007

Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number 002 M
Processing Code 003 M 900000 for PIN Change
Transmission Date and Time (007 M
‘Systems Trace Audit Number O17 M
Time, Local Transaction 012 M
Date, Local Transaction 013 M
Date, Settlement 015 M ‘Acquirers settlement date
Point of Service Entry Mode 022 M Please refer to 4.1.2 for values
‘Application PAN Sequence Number 023 c Required for ICC transactions, or if the card's issue
number has been manually entered
Point of Service Condition Code 025 M
‘Acquiring Institution Identification 032 M
Code
Forwarding Institution Identification 033 Not required
Code
Track 2 Data 035 Cc Will not be present where card details manually
entered

Retrieval Reference Number 037 M Please refer to 4.1.2 for contents of the field
Card Acceptor Terminal Identification 041 M
Card Acceptor Identification Code 042 M
Card Acceptor Name / Location 043 M
PIN Data 052 M Contains the old PIN
‘Advice / Reversal Reason Code 060 Cc Required for ICC and fallback transactions
Point of Service Data 061 M Please refer to 4.1.2 for values
Message Authentication Code 064 Not fo be sent fo LINK for this implementation
Bit Map Tertiary 065 Cc Required for ICC transactions
‘Authorisation Data 123 M

Sub-field 13: New PIN M

Sub-field 14: Issuer Script Result ‘Omitted, not for this transaction type

‘Sub-field 17: Cheque Deposit ‘Omitted, not for this transaction type
Details

Sub-field 18: Bilateral Discretionary Cc
Data
Terminal Capability Profile 130 Cc Required for ICC transactions
Terminal Verification Results 131 Cc Required for ICC transactions
Unpredictable Number 132 Cc Required for ICC transactions
Terminal Serial Number 133, i) Optional for ICC transaction - to be inserted if available
Issuer Application Data 134 Cc Required for ICC transactions
‘Cryptogram (ARQC) 136 Cc Required for ICC transactions
‘Application Transaction Counter 137 Cc Required for ICC transactions
Application Interchange Profile 138 Cc Required for ICC transactions
Cryptogram Transaction Type 144 Cc Required for ICC transactions
Terminal Country Code 145 Cc Req'd for ICC transactions — see 4.1.2 for value
Terminal Transaction Date 146 Cc Required for ICC transactions
Cryptogram Amount 147 Cc Required for ICC transactions
Cryptogram Currency Code 148 Cc Required for ICC transactions
Message Authentication Code 192 Not requirediin this implementation

Created on 19/03/2007 Version 4.0 Page 28 of 55
NBX - LINK Application

Interface Specification (AIS)
COMMERCIAL IN CONFIDENCE

FUJ00002044
FUJ00002044

Project: EMV - Banking and Retail

Doc Ref: NB/IFS/024

4.2.3

4.2.3.1 Overview

[R3] - Financial Transaction Request - Withdrawal

This message is sent by the NBX to LINK. The message requests a withdrawal transaction.

The [R3] Financial Transaction Request message maps to the following LINK message:

e 0200 - Financial Transaction Request.

4.2.3.2 Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 Cc Required for ICC transactions
Primary Account Number 002 M
Processing Code 003 M 010000 for Financial Transaction
‘Amount, Transaction 004 M
‘Amount, Cardholder Billing (006 Not required
Transmission Date and Time 007 M
Conversion Rate, Cardholder Billing 010 Not required
‘Systems Trace Audit Number O11 M
Time, Local Transaction 012 M
Date, Local Transaction 013 M
Date, Expiration 014 c Not required
Date, Settlement 015 M ‘Acquirer's settlement date
Point of Service Entry Mode 022 M Please refer to 4.1.2 for values
Application PAN Sequence 023 Cc Required for ICC transactions, or if the card's issue
number has been manually entered
Point of Service Condition Code 025 M
‘Amount, Transaction Fee 028 Not required acquirer charge will not be used
Acquiring Institution Identification 032 M
Code
Forwarding Institution Identification 033 Not required.
Code
Track 2 Data 035 Cc Will not be present where card details manually
entered.
Retrieval Reference Number 037 M Please refer to 4.1.2. for contents of the field
Card Acceptor Terminal Identification 041 M
Card Acceptor Identification Code 042 M
Card Acceptor Name / Location 043 M
‘Currency Code, Transaction 049 M
‘Currency Code, Cardholder Billing 051 Not required
PIN Data 052 c Required if PIN used
‘Advice / Reversal Reason Code 060 Cc Required for ICC and fallback transactions
Point of Service Data 061 M Please refer to 4.1.2 for values
Message Authentication Code 064 Not fo be sent fo LINK for this implementation:
Bit Map Tertiary 065 c Required for ICC transactions
Authorisation Data 123, Cc Required if any sub-field present
Sub-field 13: New PIN Omitted, not for this transaction type
‘Sub-field 14: Issuer Script Result Omitted, not for this transaction type
Sub-field 17: Cheque Deposit ‘Omitted, not for this transaction type
Details
Sub-field 18: Bilateral Discretionary Cc Required if start date of card exists and card details
Data are manually entered
Terminal Capability Profile 730 Cc Required for ICC transactions
Terminal Verification Results 131 Cc Required for ICC transactions
Unpredictable Number 132 Cc Required for ICC transactions
Terminal Serial Number 133, ° Optional for ICC transaction
Issuer Application Data 134 Cc Required for ICC transactions
‘Cryptogram (ARQC) 136 Cc Required for ICC transactions
Application Transaction Counter 137 Cc Required for ICC transactions
Application Interchange Profile 138 Cc Required for ICC transactions
Cryptogram Transaction Type 144 Cc Required for ICC transactions
Created on 19/03/2007 Version 4.0 Page 29 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS)
Pp (AIS) Doc Ret: NB/IFS/024
COMMERCIAL IN CONFIDENCE
Terminal Country Code 145 Cc Req'd for ICC transactions — see 4.1.2 for value
Terminal Transaction Date 146 Cc Required for ICC transactions
Cryptogram Amount 147 Cc Required for ICC transactions
Cryptogram Currency Code 148 Cc Required for ICC transactions
Message Authentication Code 192 Not requirediin this implementation
Created on 19/03/2007 Version 4.0 Page 30 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

4.2.4 [R3] - Financial Transaction Request - Deposit

4.2.4.1 Overview
This message is sent by the NBX to LINK. The message details a cash deposit or cheque deposit

request. Mixed deposits ie cash and cheque in one transaction will not be supported on this interface.

The [R3] Financial Transaction Request message maps to the following LINK message:

e 0200 - Financial Transaction Request

4.2.4.2 Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 Cc Required for ICC transactions
Primary Account Number (002 M
Processing Code 003 M 7210000 for cash deposit
240000 for cheque deposit
‘Amount, Transaction 004 M
‘Amount, Cardholder Billing 006 Not required
Transmission Date and Time 007 M
Conversion Rate, Cardholder Billing 010 Not required
‘Systems Trace Audit Number O11 M
Time, Local Transaction 012 M
Date, Local Transaction 013 M
Date, Expiration 014 Cc Required for manually key entered deposit transaction
Date, Settlement 015 M Acquirer’s settlement date
Point of Service Entry Mode 022 M Please refer to 4.1.2 for values
Application PAN Sequence Number 023 Cc Required for ICC transactions, or if the card's issue
number has been manually entered
Point of Service Condition Code 025 M
‘Amount, Transaction Fee 028 Not required - acquirer charge will not be used
‘Acquiring Institution Identification 032 M
Code.
Forwarding Institution Identification 033 Not required.
Code
Track 2 Data 035 Cc Will not be present where card details manually
entered.
Retrieval Reference Number 037 M Please refer to 4.1.2 for contents of the field
‘Card Acceptor Terminal Identification 047 M
Card Acceptor Identification Code 042 M
Card Acceptor Name / Location 043 M
‘Currenoy Code, Transaction 049 M
Currency Code, Cardholder Billing 051 Not required
PIN Data 052 Not required for deposit transactions
‘Advice / Reversal Reason Code 060 Cc Required for ICC transactions and fallback
transactions
Point of Service Data 061 M Please refer to 4.1.2 for values
Message Authentication Code. 064 Not to be sent to LINK for this implementation.
Bit Map Tertiary 065 Cc Required for ICC transactions
Authorisation Data 123 c Required if any sub-field present
Sub-field 13: New PIN Omitted, not for this transaction type
Sub-field 14: Issuer Script Result ‘Omitted, not for this transaction type
Sub-field 17: Cheque Deposit c Required for cheque deposit. Contains 1 for cheque
Details deposit (number of cheques) and value of transaction
inserted
Sub-field 18: Bilateral Discretionary Cc Required if start date of card exists and card details,
Data are manually entered
Terminal Capability Profile 130 Cc Required for ICC transactions
Terminal Capability Profile 130 Cc Required for ICC transactions
Terminal Verification Results 131 Cc Required for ICC transactions
Unpredictable Number 132, Cc Required for ICC transactions
Created on 19/03/2007 Version 4.0 Page 31 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS)
Pp (AIS) Doc Ret: NB/IFS/024

COMMERCIAL IN CONFIDENCE

Terminal Serial Number 133 ° Optional for ICC transaction — to be inserted if
available
Tssuer Application Data 134 c Required for ICC transactions
Cryptogram (ARQC) 136 Cc Required for ICC transactions
Application Transaction Counter 137 Cc Required for ICC transactions
Application Interchange Profile 138 Cc Required for ICC transactions
Cryptogram Transaction Type 144 Cc Required for ICC transactions
Terminal Country Code 145, Cc Req'd for ICC transactions ~ see 4.1.2 for value
Terminal Transaction Date 146 Cc Required for ICC transactions
Cryptogram Amount 147 Cc Required for ICC transactions
Cryptogram Currenoy Code 148 Cc Required for ICC transactions
Message Authentication Code. 192 Not required in this implementation
Created on 19/03/2007 Version 4.0 Page 32 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.5 [A1] - Balance Enquiry Response
4.2.5.1 Overview
This message is sent by LINK to the NBX. The message contains a balance enquiry response.
The [A1] Balance Enquiry Response message maps to the following LINK messages:
« 0110 - Balance Enquiry Response
4.2.5.2 Message Definition
Message Element Bitmap Required] Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number (002 M Echoed from the request message
Processing Code (003 M Echoed from the request message
Transmission Date and Time (007 M
‘Systems Trace Audit Number on M Echoed from the request message
Time, Local Transaction 012 M Echoed from the request message
Date, Local Transaction 013 M Echoed from the request message
Date, Settlement 015 M Switch settlement date
Application PAN Sequence 023 Cc Echoed from the request message if present
‘Acquiring Institution Identification 032 M Echoed from the request message
Code
Forwarding Institution Identification 033 Not required because not in request.
Code
Retrieval Reference Number 037 M Echoed from the request message
Response Code. 039 M
Card Acceptor Terminal Identification 041 M Echoed from the request message
Card Acceptor Identification Code (042 Not required because omitted in request message
Currency Code, Transaction 049 M Echoed from the request message
‘Additional Amounts 054 M For a decline, the length of this field must be set to
“000°
Bit Map Tertiary 065 Cc Required for ICC transactions
Account Identification 1 102 M Not used by NBX
‘Authorising Agent Institution Id Code 113, M
Issuer Trace Id 126 M
Message Authentication Code 128 Not tobe sent to LINK for this implementation,
Application Transaction Counter 137, c Required for ICC transactions
Issuer Authentication Data 139 Cc Required for ICC transactions (omitted if cannot be
generated)
issuer Script 742 ie) At Issuer's discretion
Message Authentication Code 192. Not required in this implementation
Created on 19/03/2007 Version 4.0 Page 33 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.6  [A1] - PIN Change Response
4.2.6.1 Overview
This message is sent by LINK to the NBX. The message contains the response for a PIN Change
Request.

The [A1] PIN Change Response message maps to the following LINK message:

* 0110 - PIN Management Authorisation Response

4.2.6.2 Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference

Bit Map Secondary 001 M

Primary Account Number (002 M Echoed from the request message

Processing Code 003 M Echoed from the request message

Transmission Date and Time 007 M

‘Systems Trace Audit Number O11 M Echoed from the request message

Time, Local Transaction 012 M Echoed from the request message

Date, Local Transaction 013 M Echoed from the request message

Date, Settlement 015 M ‘Switch settlement date

Application PAN Sequence 023 Cc Echoed from the request message if present

‘Acquiring Institution Identification 032 M Echoed from the request message

Code

Forwarding Institution Identification 033 Not required because not in request

Code

Retrieval Reference Number 037, M Echoed from the request message.

Response Code 039 M

‘Card Acceptor Terminal Identification 041 M Echoed from the request message

Bit Map Tertiary 065 Cc Required for ICC transactions

‘Authorising Agent Institution Id Code 113 M

Authorisation Response Data 121 Not required in NBX implementation

Issuer Trace Id 126 M

‘Message Authentication Code 128 Not fo be sent by LINK for this implementation

Application Transaction Counter 137 Cc Required for ICC transactions

Issuer Authentication Data 139) c Required for ICC transactions (omitted if cannot be
generated)

Issuer Script 142 c Required for approved PIN Change if appropriate for
the IC card (e.g. card with offline PIN). May be present
for denied transactions

Message Authentication Code 192 Not required in this implementation

Created on 19/03/2007 Version 4.0 Page 34 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.7 [A1] - Financial Transaction Request Response - Withdrawal
4.2.7.1 Overview
This message is sent by LINK to the NBX. The message contains a withdrawal request response.
The [A1] Financial Transaction Request Response message maps to the following LINK message:
¢ 0210 - Financial Transaction Request Response.
Note that LINK will never return a partial authorisation.
4.2.7.2 Message Definition
Message Element Bitmap Required] Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number (002 M Echoed from the request message
Processing Code 003 M Echoed from the request message
‘Amount, Transaction 004 M Echoed from the request message
‘Amount, Cardholder Billing 006 Not required
Transmission Date and Time 007 M
Conversion Rate, Cardholder Billing 010 Not required
Systems Trace Audit Number on M Echoed from the request message
Time, Local Transaction 012 M Echoed from the request message
Date, Local Transaction 013 M Echoed from the request message
Date, Settlement 015 M Switch settlement date
Application PAN Sequence 023 Cc Echoed from the request message if present
‘Amount, Transaction Processing Fee 030 Cc Field will not be returned by LINK in a LINK denied
transaction.
‘Acquiring Institution Identification 032 M Echoed from the request message
Code
Forwarding Institution Identification 033 Not required because not in request
Code
Retrieval Reference Number 037 M Echoed from the request message
Response Code. 039 M
Card Acceptor Terminal Identification 041 M Echoed from the request message
Currency Code, Transaction 049 M Echoed from the request message
Curreney Code, Cardholder Billing 051 Not required
‘Additional Amounts 054 Cc Required if available from issuer
Bit Map Tertiary 065 Cc Required for ICC transactions
Account Identification 1 102 M Not used by NBX
Authorising Agent Institution Id Code 113 M
‘Authorisation Response Data 124 Not required in NBX implementation
Issuer Trace Id 126 M
‘Message Authentication Code 128 Not fo be sent to LINK for this implementation,
Application Transaction Counter 137, c Required for ICC transactions
Issuer Authentication Data 139 Cc Required for ICC transactions (omitted if cannot be
generated)
Issuer Script 742 io) At Issuer's discretion
Message Authentication Code 192 Not required in this implementation
Created on 19/03/2007 Version 4.0 Page 35 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.8  [A1] - Financial Transaction Request Response - Deposit
4.2.8.1 Overview
This message is sent by LINK to the NBX. The message contains a deposit request response.
The [A1] Financial Transaction Request Response message maps to the following LINK message:
¢ 0210 - Financial Transaction Request Response.
Note that LINK will never return a partial authorisation.
4.2.8.2 Message Definition
Message Element Bitmap Required] Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number (002 M Echoed from the request message
Processing Code 003 M Echoed from the request message
‘Amount, Transaction 004 M Echoed from the request message
‘Amount, Cardholder Billing 006 Not required
Transmission Date and Time 007 M
Conversion Rate, Cardholder Billing 010 Not required
Systems Trace Audit Number on M Echoed from the request message
Time, Local Transaction 012 M Echoed from the request message
Date, Local Transaction 013 M Echoed from the request message
Date, Settlement 015 M Switch settlement date
Application PAN Sequence 023 Cc Echoed from the request message if present
‘Amount, Transaction Processing Fee 030 Cc Field will not be returned by LINK in a LINK denied
transaction.
‘Acquiring Institution Identification 032 M Echoed from the request message
Code
Forwarding Institution Identification 033 Not required because not in request.
Code
Retrieval Reference Number 037 M Echoed from the request message
Response Code. 039 M
Card Acceptor Terminal Identification 041 M Echoed from the request message
Currency Code, Transaction 049 M Echoed from the request message
Curreney Code, Cardholder Billing 051 Not required
‘Additional Amounts 054 Cc Required if available from issuer
Bit Map Tertiary 065 Cc Required for ICC transactions
Account Identification 1 102 M Not used by NBX
Authorising Agent Institution Id Code 113, M
‘Authorisation Response Data 124 Not used in the NBX implementation
Issuer Trace Id 126 M
Message Authentication Code 128 Not fo be sent to LINK for this implementation.
Application Transaction Counter 137, c Required for ICC transactions
Issuer Authentication Data 139 Cc Required for ICC transactions (omitted if cannot be
generated)
Issuer Script 742 io) At Issuer's discretion
Message Authentication Code 192 Not required in this implementation
Created on 19/03/2007 Version 4.0 Page 36 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.9 [E1] - Reversal Request — Financial Transaction
4.2.9.1 Overview
This message is sent by the NBX to LINK when a financial transaction that has been processed by the
issuer needs to be reversed.
The [E1] message maps to the following LINK messages:
* 0420 - Reversal Request
e 0421 - Reversal Repeat.
A Reversal Request [E1] can only be generated when the [A1] message to be reversed can be mapped
against a [R3] request.
Reversal Requests may be sent up to a (configurable) period, initially set to 5 days, after the original
transaction to which it refers.
Note that partial reversals are not supported over this interface.
4.2.9.2 Message Definition
Message Element Bitmap Required] Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number 002 M
Processing Code (003 M Copied from the [A7]
‘Amount, Transaction 004 M
‘Amount, Cardholder Billing 006 Not required
Transmission Date and Time (007 M
Conversion Rate, Cardholder Billing 010 Not required
‘Systems Trace Audit Number O11 M
Time, Local Transaction 012 M
Date, Local Transaction 013 M
Date, Expiration 014 c Required if present on original transaction. Copied
from original transaction
Date, Settlement 015 M Copied from the [R3]
Point of Service Entry Mode 022 M
Application PAN Sequence Number 023 Cc Required if present on original transaction
Point of Service Condition Code 025 M
‘Amount, Transaction Fee 028 Not required - acquirer charge will not be used
Acquiring Institution Identification 032 M
Code
Forwarding Institution Identification 033 Not required
Code
Track 2 Data 035 Cc Required if present on original transaction
Retrieval Reference Number 037 M
Authorisation Identification Response 038 Not required
Response Code 039 M Copied from the [A]
‘Card Acceptor Terminal Identification 041 M
Card Acceptor Identification Code 042 M
Card Acceptor Name / Location 043 M
‘Currency Code, Transaction 049 M
Currency Code, Cardholder Billing 051 Not required
‘Advice / Reversal Reason Code 060 M
Point of Service Data 061 M
Bit Map Tertiary 065 Cc Required for ICC transactions if any of the optional
fields included
Original Data Elements 090 M
Replacement Amounts 095 Not required
Account Identification 1 102 M
Created on 19/03/2007 Version 4.0 Page 37 of 55

© Post Office™ 2004-2007
NBX - LINK Application

Interface Specification (AIS)
COMMERCIAL IN CONFIDENCE

FUJ00002044

FUJ00002044

Project: EMV - Banking and Retail

Doc Ref: NB/IFS/024

‘Authorisation Response Data

124

Not used in the NBX implementation

Authorisation Data

123

Required if present on original transaction. Copied
from original transaction

Issuer Trace Id

126

Terminal Capability Profile

130

Optional for ICC transactions. Copied from original
transaction

Terminal Verification Results

131

oO} oIz

Optional for ICC transactions.

This should contain the latest TVR which may be
different to that in the original request. If the latest TVR
is unavailable, the value in the original request should
be used

Unpredictable Number

132

°

Optional for ICC transactions. Copied from original
transaction

Terminal Serial Number

133

Optional for ICC transactions. Copied from original
transaction

Issuer Application Data

134

Optional for ICC transactions.
This should contain the latest IAD which may be
different to that in the original request. If the latest IAD
is unavailable, the value in the original request should
be used

Cryptogram (ARQC)

136

Optional for ICC transactions.

This should contain the ARQC from the 2" Gen. AC
command or if unavailable, the ARQC from the 1*
Gen. AC command

Application Transaction Counter

137

Optional for ICC transactions. Copied from original
transaction

Application interchange Profile

138

Optional for ICC transactions, Copied from original
transaction

Cryptogram Transaction Type

144

Optional for ICC transactions. Copied from original
transaction

Terminal Country Code

145

Optional for ICC transactions. Copied from original
transaction

Terminal Transaction Date

146

Optional for ICC transactions. Copied from original
transaction

Cryptogram Amount

147

Optional for ICC transactions, Copied from original
transaction

Cryptogram Currency Code

148

oO] of of of Of of o

Optional for ICC transactions. Copied from original
transaction

Message Authentication Code

192

Not required in this implementation

Note:

NBX does not include any of the Optional fields.

Created on 19/03/2007
© Post Office™ 2004-2007

Version 4.0

Page 38 of 55
FUJ00002044

FUJ00002044
NBX - LINK Application Project: EMV - Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE
4.2.10 [E41] - Reversal Request - PIN Change
4.2.10.1 Overview
This message is sent by the NBX to LINK when a PIN Change that has been processed by the issuer
needs to be reversed due to:
e NBxX timing out waiting for the response to the original [R3] PIN Change Authorisation Request
« Counter has failed to successfully change the offline PIN
The [E1] message for a PIN Change reversal maps to the following LINK messages:
© 0624 - PIN Management Failure Advice
* 0625 - PIN Management Failure Advice Repeat.
Reversal Requests may be sent up to a (configurable) period, initially set to 5 days, after the original
transaction to which it refers.
Note that partial reversals are not supported over this interface.
4.2.10.2 Message Definition
Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 M
Primary Account Number (002 M Copied from original transaction, ie. the [R3]
Processing Code (003 M Copied from original transaction
Transmission Date and Time (007 M
‘Systems Trace Audit Number on M Copied from original transaction
Time, Local Transaction 012 M Copied from original transaction
Date, Local Transaction 013 M Copied from original transaction
Date, Settlement 015 M Copied from original transaction
Point of Service Entry Mode 022 M Copied from original transaction
‘Application PAN Sequence Number 023 ) Optional. NBX will generate it if present on original
transaction
Point of Service Condition Code 025 M Copied from original transaction
‘Acquiring Institution Identification 032 M Copied from original transaction
Code
Forwarding Institution Identification 033 Not required
Code
Track 2 Data 035 Cc Required if present on original transaction
Retrieval Reference Number 037 M Copied from original transaction
Card Acceptor Terminal Identification 041 M Copied from original transaction
Card Acceptor Identification Code 042 M Copied from original transaction
Card Acceptor Name / Location 043 M Copied from original transaction
‘Advice / Reversal Reason Code 060 M
Point of Service Data 061 M Copied from original transaction
Bit Map Tertiary 065 Cc Required for ICC transactions if any of the optional
fields included
Original Data Elements 080 M
Authorisation Data 123 M
Sub-field 13: New PIN ‘Omitted, not for this transaction type
Sub-field 14: Issuer Script Result M Please refer to 4.1.2. for contents of the sub-field
Sub-field 17: Cheque Deposit ‘Omitted, not for this transaction type
Details
‘Sub-field 18: Bilateral Discretionary Cc Required if present on original transaction. Copied
Data from original transaction
Issuer Trace Id 126 M Copied from the [A1], or 000000 if timed out waiting for
the [A1]
Created on 19/03/2007 Version 4.0 Page 39 of 55

© Post Office™ 2004-2007
NBX - LINK Application

Interface Specification (AIS)
COMMERCIAL IN CONFIDENCE

FUJ00002044

FUJ00002044

Project: EMV - Banking and Retail

Doc Ref: NB/IFS/024

Note:

Terminal Capability Profile 130 Optional for ICC transactions. Copied from original
transaction

Terminal Verification Results 131 Optional for ICC transactions.
This should contain the latest TVR which may be
different to that in the original request. If the latest TVR
is unavailable, the value in the original request should
be used

Unpredictable Number 732 Io) Optional for ICC transactions. Copied from original
transaction

Terminal Serial Number 133 Optional for ICC transactions. Copied from original
transaction

Issuer Application Data 134 Optional for ICC transactions.
This should contain the latest [AD which may be
different to that in the original request. If the latest IAD
is unavailable, the value in the original request should
be used

Cryptogram (ARQC) 136 ° Optional for ICC transactions.
This should contain the ARQC from the 2" Gen. AC
command or if unavailable, the ARQC from the 1"
Gen. AC command

Application Transaction Counter 137 ° Optional for ICC transactions. Copied from original
transaction

Application Interchange Profile 138 ° Optional for ICC transactions. Copied from original
transaction

Cryptogram Transaction Type 144 ° Optional for ICC transactions. Copied from original
transaction

Terminal Country Code 145 ° Optional for ICC transactions. Copied from original
transaction

Terminal Transaction Date 146 I) Optional for ICC transactions. Copied from original
transaction

Cryptogram Amount 147 ° Optional for ICC transactions. Copied from original
transaction

Cryptogram Currency Code 148 ° Optional for ICC transactions. Copied from original
transaction

Message Authentication Code 192 Not required in this implementation

NBX does not include any of the Optional fields.

Created on 19/03/2007 Version 4.0 Page 40 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

4.2.11 [E2] - Reversal Request Response — Financial Transaction

4.2.11.1 Overview
This message is sent by LINK to the NBX in response to an 0420/0421 reversal request from the NBX.

The [E2] message maps to the LINK message 0430.

4.2.11.2 Message Definition

Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 M
Processing Code 003 M Echoed from the 042x message.
‘Amount, Transaction (004 M Echoed from the 042x message.
Transmission Date and Time 007 M
‘Systems Trace Audit Number O11 M Echoed from the 042x message.
Time, Local Transaction 012 M Echoed from the 042x message.
Date, Local Transaction 013 M Echoed from the 042x message.
Date, Settlement 015 M Echoed from the 042x message.
Application PAN Sequence 023 Cc Required if present on original transaction
Acquiring Institution Identification 032 M Echoed from the 042x message.
Code:
Forwarding Institution Identification 033 Not required
Code
Retrieval Reference Number 037 M Echoed from the 042x message.
Response Code 039 M
‘Currency Code, Transaction 049 M Echoed from the 042x message.
Bit Map Tertiary 065 Cc Required for ICC transactions
Original Data Elements 090 M Echoed from the 042x message.
Replacement Amounts 095 Not required
‘Authorisation Response Data 121 Not required
‘Authorisation Data 123 Not required
Issuer Trace Id 126 M Echoed from the 042x message.
Application Transaction Counter 137 Cc Required for ICC transactions if present in reversal
request. Copied from request
Cryptogram Transaction Type 144 ° Optional for ICC transactions. Copied from original
transaction
Message Authentication Code 192 Not required in this implementation.
Created on 19/03/2007 Version 4.0 Page 41 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

4.2.12 [E2] - Reversal Request Response — PIN Change

4.2.12.1 Overview

This message is sent by LINK to the NBX in response to an 0624/0625 PIN Management Failure Advice
request from the NBX.

The [E2] message for a PIN Change reversal maps to the following LINK message:
* 0634 - PIN Management Failure Advice Response

4.2.12.2 Message Definition

Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 M
Processing Code 003 M Echoed from the 0624/0625 message
Transmission Date and Time (007 M
‘Systems Trace Audit Number mt M Echoed from the 0624/0625 message
Time, Local Transaction’ 012 M Echoed from the 0624/0625 message
Date, Local Transaction 013 M Echoed from the 0624/0625 message
Date, Settlement 015 M Echoed from the 0624/0625 message
Application PAN Sequence 023 c Required if present on 0624/0625 message. Echoed
from the 0624/0625 message
‘Acquiring Institution Identification 032 M Echoed from the 0624/0625 message
Code
Forwarding Institution Identification 033 Not required
Code
Retrieval Reference Number 037 M Echoed from the 0624/0625 message
Response Code 039 M
Bit Map Tertiary 065 Cc Required if ICC fields present
Original Data Elements 080 M Echoed from the 0624/0625 message
Issuer Trace Id 126 M Echoed from the 0624/0625 message
Application Transaction Counter 137 Cc Required for ICC transactions if present in reversal
request. Echoed from the 0624/0625 message
Message Authentication Code 192 Not required in this implementation
Created on 19/03/2007 Version 4.0 Page 42 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

4.2.13 Administration Advice (0620)

4.2.13.1 Overview

Administration advice messages are sent to/from LINK in order to initiate investigation of a problem by
either LINK or the NBX.

The Administration advice message maps to LINK message 0620.

4.2.13.2 Message Definition

‘Message Element Bitmap Required I Notes / Conditions
Reference
Bit Map Secondary 001 M
Transmission Date and Time 007 M
‘Systems Trace Audit Number O11 M
Network Management Information 070 M Set to be 900
Code
Info Text 724 M
Created on 19/03/2007 Version 4.0 Page 43 of 55

© Post Office™ 2004-2007
FUJ00002044

FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

4.2.14 Network Management Messages (0800 / 0810)
The following Network Management Messages will be exchanged between LINK and the NBX:
e 0800 - Network Management Request Message

0810 - Network Management Response Message

They are used for the following purposes (followed by associated Network Management Information Code):

Sign On, acquirer, LINK initiated (061)

Sign On, acquirer, NBX initiated (071)

Sign Off, acquirer, LINK initiated (062)

Sign Off, acquirer, NBX initiated (072)

End of Day, Acquirer from LINK (261)

Handshake, Acquirer from LINK (361)

Handshake, Acquirer from NBX (371)

Key Change - Acquirer Zone from LINK (161)

Key Change Request - Acquirer Zone from NBX (181)
Online Key Verification Acquirer ZMK from LINK (199)

The usage, sequence and inter-relation between these and other message is defined in the body of the
document “LINK Switch Service Interchange Standard (LIS5)"(Ref. [1]) and in Appendix C1 of the “LISS
Security Standard” section of that document under Network Management Option 2 (Ref. [7]).

4.2.14.1 Network Management Request (0800)

Message Element Bitmap Required] Notes / Conditions
Reference

Bit Map Secondary 001 M

Transmission Date and Time (007 M

‘Systems Trace Audit Number on M Set for this transaction — a new STAN is used when a
0800 message is repeated

Network Management Information 070 M Values will depend on message purpose, as described

Code above

Message Security Code 096 Cc Required for key change, key verification, logon and
logott

Network Management information 725, Cc Required for key change and key verification

4.2.14.2 Network Management Request Response (0810)

Message Element Bitmap ] Required ] Notes/ Conditions
Reference
Bit Map Secondary 001 M
Transmission Date and Time (007 M
‘Systems Trace Audit Number on M Echoed from the 0800
Response Code. 039 M
Network Management Information Code 070 M This is echoed from the 0800 received message.

Created on 19/03/2007 Version 4.0 Page 44 of 55

© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

4.2.15 LREC - Reconciliation File

The LREC reconciliation file which is sent from LINK to the NBX is in accordance with the LINK Reconciliation
File Specification (LREC) Standard Formats, (Ref. [2]). The file transfer mechanism and conditions of transfer
are described in the NBX — LINK Technical Interface Specification (Ref. [4]).

Created on 19/03/2007 Version 4.0 Page 45 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

5 Transfer Structure

5.1 Transfer Grouping

The following figures show the end to end message sequences, using the RACE (Request / Authorise /
Confirm / Exception) model, for all application messages between the NBX and the LINK Switch. No
knowledge is assumed of the interface between LINK and its member financial institutions.

Counter Systems

_. LIN
‘a ~S K
t [+ I
[0800] [o810] a0 Gato LREC
"nx we
Horizon “see ae

DRS

Figure 1 - LINK Message Flows in the Network Banking Environment

UN

NBX

Horizon
Counter Systems

DRS

Figure 2 - LINK Message Flows for PIN Change

A 0620 message may be issued by the NBX in response to all messages from LINK (for simplicity, only one
such flow is shown on the diagrams).
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

Reversals for Financial Transactions (0420 messages) are not sent from NBX to LINK unless and until an
approved response (0210 message) has been received from LINK. Repeat Reversals (0421) are only sent in
the event that the prior 0420 (or 0421) reversal messages have not had a response processed at the NBX.

Reversals for PIN Change Transactions (0624 messages) sent from NBX to LINK need not wait for the receipt
of a response (0110 message) from LINK. An 0624 is sent when NBX times out the receipt of the 0110 from
LINK. Repeat Reversals (0625) are only sent in the event that the prior 0624 (or 0625) reversal messages
have not had a response processed at the NBX.

Each incoming request is time-stamped as it is received by LINK. The settlement day in which the transaction
will be processed will depend on whether the transaction was time-stamped before or after LINK transmitted
the 0800 cut-over message (irrespective of whether a subsequent 0810 message was received).

The interface should be resilient to the transfer of duplicate messages; in practice, however, this should only
happen after failure and recovery of either end of the interface.

LINK will not validate transmission date and time in messages against the date and time that messages are
received.

The interface details are also described in the NBX — LINK Technical Interface Specification (Ref. [4])

5.2 Transfer Structure

The messages defined in this AIS will be exchanged in accordance with Section 3 of the LINK Switch Service
Interchange Standard (LIS5), (Ref. [1]), which describes the use of Message Type Identifier, Bit Map and Data
Elements in the message structure. Note that the messages exchanged over this interface use the third bit
map for the ICC data elements.

Messages for one transaction may be interleaved with messages for any other transaction.

5.3 Record Structure

The record structure for the messages defined in this AIS is as described in the LISS Interchange Standard,
Reference (Ref. [1]). The details are not repeated here.

The record structure for the LREC file passed over this interface is described in LINK Reconciliation File
Specification (LREC) Standard Format, (Ref. [2]). The details are not repeated here.

5.4 Sequences

Figure 1 above (see Section 5.1) shows the end to end message sequences of all the messages supported by
this AIS, from the PO Outlet to the issuing financial institution. Further detail relating specifically to the NBX -
LINK connection can be found in the NBX — LINK Technical Interface Specification (Ref. [4]). The interface
must be resilient to the disconnection or loss of any part of the total network banking environment for short or
extended periods.

5.5 Data Volumes

Data Rates and Volumes over this interface are addressed through the NB Volume Model Comparisons, (Ref.
(3]).

Created on 19/03/2007 Version 4.0 Page 47 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

5.6 Data Authentication

For this implementation, Message Authentication Codes (MACs) will not be included in the messages sent
between the NBX and LINK.

5.7 Data Dictionary

The Data Elements used on this interface are defined and described within Appendix G of the LINK Switch
Service Interchange Standard (LIS5), (Ref. [1]).

Created on 19/03/2007 Version 4.0 Page 48 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

6 Security of Transmitted Data

The security standards for the LINK-NBX interface are described in the NBX — LINK Technical Interface
Specification (Ref. [4]).

6.1 Protected Data

PIN blocks that pass across the interface from NBX to LINK are encrypted under an Acquirer Working Key
(AWK). This key is used in the LINK — NBX shared security zone. PIN Block encryption is translated from

internal keys to protection under this shared key using a hardware encryption module. The PIN blocks are

never rendered in clear outside the hardware module.

Acquirer Working Keys are exchanged electronically under a Acquirer Zone Master Key (AZMK) shared
between NBX and LINK. The AZMK is generated and owned by the NBX. The AWK is owned and generated
by LINK.

6.2 Encryption and Decryption Methods

PIN Block and Acquirer Working Key transmission is protected by Triple DES double length keys, 112bit plus
key check data.

All data transmitted on communication lines between the NBX and LINK is encrypted using Line Encryption
Units. LINK is responsible for the Line Encryption Units at both ends of the communication line.

6.3 Session Establishment

Sessions Establishment can be initiated by LINK or NBX. Initial Logon messages exchanges are followed by
transmission by LINK to NBX of a new AWK with a key check value protected by encryption under the shared
current AZMK.

NBX verifies the key and acknowledges it to LINK. All PIN Block data is protected by this AWK until the
session ends or the AWK is renewed.

6.4 Key Management

Key ownership is described in section 5.4 of the NBX — LINK Technical Interface Specification (Ref. [4]). LINK -
NBX Zone Management Keys are managed by the Horizon Key Management Application (KMA) with manual
processes.
According to local manual processes the NBX staff will:
e Generate three new AZMK components
e Transfer the AZMK components onto secure stationery
e Key components will contain
e Akey identifier (visible)
e Akey generation date (visible)
« Acomponent number (visible)
e 32 hex characters in eight groups of four characters — component plus check data (hidden)

Created on 19/03/2007 Version 4.0 Page 49 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

e Provide a Key Manager Key Check value
e Load the keys into the Horizon KMA

The Horizon KMA:

e Activates keys for use by Horizon Agents, which manage the TCP/IP connections to LINK.
Keys component documents must be stored and transported separately and securely.

The LINK — NBX AZMK is renewed every six months by this manual procedure. The AZMK, having been
produced as described above, is securely transported, manually, to LINK. It is expected that the resulting
online key verification message sequence would be preceded by telephone co-ordination. If this online key
verification procedure is successful, it is followed by the manual promotion of the AZMK, where the Next
AZMK becomes the Current AZMK. It is recommended that after promotion of the keys, an Operator issue a
command to drive an AWK Key change request sequence, in order to test that the verified AZMK has been
promoted by both parties.

LINK requires more than one Processor Interface (PI) to support the transaction throughput for the NBX. For
this configuration each PI will be configured to support one TCP/IP socket connection. A logical session will
be initiated by a logon, and data for that session will flow over the socket connection belonging to that Pl (see
Ref. [5] for further details). Each PI generates a LINK-NBX Acquirer Working Key (AWK) which it sends to
NBX for validation. This AWK, if validated by the NBX, is used by both socket connections between NBX and
the PI that generated it. Logical sessions for a different PI will use the AWK generated by that PI. All LINK
Pls will protect their AWK in transit to NBX by encryption using the same AZMK, during its six months of
currency.

The AWKs are changed under the following conditions (note that it is not necessary to change the AWKs as
soon as the AZMK is changed).

«Every 24 hours where the session remains active (an AWK may be changed at a set (configurable) clock
time and will remain valid until it is changed)

e  Atsession initiation by either party
e On receipt by LINK of a 6" consecutive invalid PIN block on a session
e When either a NBX or LINK operator requests a key change.

Load balancing between the Pls will be performed by the NBX ensuring that the appropriate AWK for the PI is
used for PIN block translation.

There may be a short outage at the FI (typically up to 90 seconds) while the manual process for changing the
AZMK is under way.

Created on 19/03/2007 Version 4.0 Page 50 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

7 Operational Procedures

7.1 Processing Cycles

This interface relates to online message exchange to support real time financial transactions, and to the daily
transmission from LINK of the LREC file.

A transaction, which is subsequently discarded, must be logged after receipt, prior to being discarded

7.2 Transfer Initiation

All transfers defined in this AIS are automatic.

7.3 Security Procedures

Manual Procedures are required to support the above key management protocol, as described in Section 6
above.

7.4 Fallback Procedures
Fallback procedures are described in the NBX — LINK Technical Interface Specification (Ref. [4]).

Each system is responsible for its own recovery after failure. Restoration of the interface and the disposal of
stale messages (other than “must deliver” messages) is expected to be automatic. 0100, 0200, 0110 and 0210
({R] and [A]), 0620 and 0800 messages awaiting transmission at the time of failure can safely be discarded, as
the integrity of the transaction is protected by timeouts.

The only messages categorised as “must deliver” are Network Management (0800) and Reversal Request
(0420/0421) messages - see Section 6 of the LINK Switch Service Interchange Standard (LISS), (Ref. [1]).
Sign On, Sign Off, Key Change, Key Change Request and Online Key Verification 0800 messages are “must
deliver” but do not have to survive across processes when moving from active to standby sites.

Handshake 0800 messages are sent every few minutes anyway (which is sufficient).

End of Day 0800 messages are “must deliver” but note that LINK will send the message just once. Whether or
not LINK receives a response, LINK will cut over to the next Settlement Day and create LREC files
accordingly. LINK will not send another End of Day message on a PI for which no response was received.
Reversal Request 0420/0421 messages are “must deliver” messages and do have to survive when moving
from active to standby sites.

7.5 Downgrade Transactions

A ‘Downgrade’ transaction is one where an IC Card has been used at an ICC enabled terminal, but the card
issuer has advised, via POL reference data (dependent upon IIN), that the card must not be processed as ICC.

The on-line message will be formatted as a standard magnetic stripe transaction.

Nothing, apart from the Track 2 Service Code in the on-line LISS Message sent to LINK, will indicate that an
IC Card was used.

Created on 19/03/2007 Version 4.0 Page 51 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV — Banking and Retail
Interface Specification (AIS)
Pt (AIS) oc ret: —_NB/IFS/024
COMMERCIAL IN CONFIDENCE

Note that in the case of a Downgrade transaction, data must not be used from the IC, but that normal
procedures must be followed as for magnetic stripe cards.

7.6 Control

The interface must be resilient to duplicate messages, which may occur after recovery of any element in the
system, but are not otherwise expected to occur.

Lost or discarded messages are handled by timeout processing at every stage of the message sequence, to
ensure that incomplete transactions are declined if unauthorised or reversed if authorised.

The NBX will log events affecting this interface (e.g. response indicating receipt by LINK of an invalid PIN
block) to an Event Log. These events will be managed by Tivoli for escalation to the relevant Help Desk, as
appropriate to the code associated with the event.

Created on 19/03/2007 Version 4.0 Page 52 of 55
© Post Office™ 2004-2007
FUJ00002044
FUJ00002044

NBX - LINK Application Project: EMV ~ Banking and Retail
Interface Specification (AIS) Doc Ref: NB/IFS/024

COMMERCIAL IN CONFIDENCE

8 Appendix A

8.1 Response Codes and Reversal Codes

These are defined in the document Horizon — LINK Mapping (Ref. [5]).

END OF DOCUMENT

Created on 19/03/2007 Version 4.0 Page 53 of 55
© Post Office™ 2004-2007
